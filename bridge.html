<!DOCTYPE html>
<html>
  <head>
    <title>Bridge App</title>
    <style>
      body {
        background: #1a1a2e;
        color: white;
        font-family: Arial;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        max-width: 500px;
      }
      input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
      }
      button {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background: #00ff88;
        color: #000;
      }
      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.3);
      }
      .active {
        color: #00ff88;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåâ NodeMCU Bridge</h1>
      <p>This app forwards commands from Vercel to your NodeMCU</p>

      <input
        type="text"
        id="nodeMcuIP"
        placeholder="NodeMCU IP (e.g., 192.168.0.101)"
        value="192.168.0.101"
      />

      <button onclick="startBridge()">üöÄ START BRIDGE</button>
      <button onclick="stopBridge()" style="background: #ff4757; color: white">
        ‚èπ STOP
      </button>

      <div class="status">
        <div>Status: <span id="status">Stopped</span></div>
        <div>Commands Forwarded: <span id="count">0</span></div>
        <div>Last Command: <span id="lastCmd">None</span></div>
      </div>

      <p style="font-size: 12px; opacity: 0.7; margin-top: 20px">
        Keep this page open while using the tracker on your phone (Vercel)
      </p>
    </div>

    <script>
      let bridgeActive = false;
      let commandCount = 0;
      let nodeMcuIP = "";

      function startBridge() {
        nodeMcuIP = document.getElementById("nodeMcuIP").value.trim();

        if (!nodeMcuIP) {
          alert("Enter NodeMCU IP address!");
          return;
        }

        // Test connection
        fetch(`http://${nodeMcuIP}/status`)
          .then((res) => res.json())
          .then((data) => {
            bridgeActive = true;
            document.getElementById("status").textContent = "Active";
            document.getElementById("status").className = "active";

            // Start listening for commands
            listenForCommands();

            alert("‚úì Bridge started!\n\nNow open your Vercel app on phone.");
          })
          .catch((err) => {
            alert(
              "Cannot connect to NodeMCU!\n\nMake sure:\n1. NodeMCU is on\n2. IP is correct\n3. Same WiFi network"
            );
          });
      }

      function stopBridge() {
        bridgeActive = false;
        document.getElementById("status").textContent = "Stopped";
        document.getElementById("status").className = "";
      }

      function listenForCommands() {
        if (!bridgeActive) return;

        // Check localStorage for commands from Vercel app
        const cmd = localStorage.getItem("motorCommand");

        if (cmd) {
          try {
            const command = JSON.parse(cmd);

            // Only process if it's a new command
            if (command.timestamp && Date.now() - command.timestamp < 1000) {
              executeCommand(command);
              localStorage.removeItem("motorCommand"); // Clear after processing
            }
          } catch (e) {
            console.error("Command parse error:", e);
          }
        }

        // Keep listening
        setTimeout(listenForCommands, 50); // Check every 50ms
      }

      async function executeCommand(command) {
        try {
          let url = `http://${nodeMcuIP}`;

          if (command.type === "move") {
            url += `/moveto?position=${command.position}&speed=${command.speed}`;
          } else if (command.type === "reset") {
            url += `/reset`;
          } else if (command.type === "status") {
            url += `/status`;
          }

          const response = await fetch(url);
          const data = await response.json();

          // Send response back to Vercel app
          localStorage.setItem(
            "motorResponse",
            JSON.stringify({
              ...data,
              timestamp: Date.now(),
            })
          );

          commandCount++;
          document.getElementById("count").textContent = commandCount;
          document.getElementById("lastCmd").textContent =
            command.type + " @ " + new Date().toLocaleTimeString();
        } catch (error) {
          console.error("Command execution error:", error);
        }
      }
    </script>
  </body>
</html>
