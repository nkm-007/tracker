<!DOCTYPE html>
<html>
<head>
    <title>Person Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Control Panel */
        #ui {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            z-index: 10;
        }
        
        .panel {
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 20px;
            backdrop-filter: blur(5px); display: flex; gap: 10px; align-items: center;
        }

        input { 
            padding: 10px; border-radius: 8px; border: none; 
            width: 130px; text-align: center; background: rgba(255,255,255,0.9);
        }
        
        button {
            padding: 10px 20px; border-radius: 25px; border: none;
            font-weight: bold; font-size: 14px; cursor: pointer;
        }
        
        .btn-start { background: #00ff88; color: #000; }
        .btn-rec { background: #ff4757; color: white; display: none; } /* Hidden until AI loads */
        
        .recording { animation: pulse 1.5s infinite; background: white; color: red; }
        
        #status {
            color: #00ff88; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,1);
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 15px;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div id="ui">
        <div id="status">Initializing AI...</div>
        
        <div class="panel">
            <input type="text" id="ip" placeholder="NodeMCU IP" value="192.168.0.105">
            <button class="btn-start" id="loadBtn" onclick="init()">Load Camera</button>
            <button class="btn-rec" id="recBtn" onclick="toggleTracking()">● START REC</button>
        </div>
    </div>
</div>

<script>
    let video, canvas, ctx, model;
    let isTracking = false;
    let lastRequestTime = 0;
    
    // Recording Variables
    let mediaRecorder;
    let recordedChunks = [];
    let stream;

    // 1. Setup Camera & Load AI
    async function init() {
        document.getElementById('status').innerText = "Requesting Camera...";
        
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');

        // Get Back Camera (Environment)
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false
        });
        
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        };

        document.getElementById('status').innerText = "Loading AI (Person Only)...";
        document.getElementById('loadBtn').style.display = "none";
        
        // Load COCO-SSD
        model = await cocoSsd.load();
        
        document.getElementById('status').innerText = "Ready to Track";
        document.getElementById('recBtn').style.display = "block";
    }

    // 2. Start/Stop Logic
    function toggleTracking() {
        const btn = document.getElementById('recBtn');
        
        if (!isTracking) {
            // START
            isTracking = true;
            btn.innerText = "■ STOP & SAVE";
            btn.classList.add('recording');
            document.getElementById('status').innerText = "Tracking Active";
            
            // Start Recording
            recordedChunks = [];
            try {
                // Try high quality VP9, fall back to standard
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            } catch (e) {
                mediaRecorder = new MediaRecorder(stream);
            }
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            mediaRecorder.onstop = saveAndUpload;
            mediaRecorder.start();
            
            // Start Loop
            trackLoop();
            
        } else {
            // STOP
            isTracking = false;
            btn.innerText = "● START REC";
            btn.classList.remove('recording');
            document.getElementById('status').innerText = "Saving Video...";
            
            mediaRecorder.stop();
        }
    }

    // 3. Save to Drive (via Share Sheet)
    async function saveAndUpload() {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        const file = new File([blob], "person_tracking_test.mp4", { type: 'video/mp4' });

        if (navigator.canShare && navigator.share) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Tracking Test',
                    text: 'Video recorded from AI Tracker'
                });
                document.getElementById('status').innerText = "Shared Successfully";
            } catch (err) {
                document.getElementById('status').innerText = "Share cancelled";
            }
        } else {
            // Desktop Fallback
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "tracking_test.mp4";
            a.click();
            document.getElementById('status').innerText = "Downloaded";
        }
    }

    // 4. The AI Loop
    async function trackLoop() {
        if (!isTracking) return;

        // Detect Objects
        const predictions = await model.detect(video);
        
        // Filter: Only look for "person"
        const person = predictions.find(p => p.class === 'person' && p.score > 0.6);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (person) {
            // Draw Box
            ctx.strokeStyle = "#00ff88";
            ctx.lineWidth = 4;
            ctx.strokeRect(...person.bbox);

            // Logic: Keep person in center
            const x = person.bbox[0];
            const width = person.bbox[2];
            const centerX = x + (width / 2);
            const screenCenter = canvas.width / 2;
            
            const error = centerX - screenCenter; // Distance from center
            
            // DEADZONE: If error is small (<50px), ignore it to stop jitter
            if (Math.abs(error) > 50) {
                
                // SMOOTHNESS MATH:
                // Divide error by 10. 
                // Ex: Error 200px -> Move 20 steps (Fast)
                // Ex: Error 60px -> Move 6 steps (Slow)
                let steps = Math.floor(error / 10);
                
                // Invert for Back Camera (Left on screen = Left in reality)
                // If using Front Camera, you might need to multiply by -1
                steps = -steps; 

                // Send to NodeMCU
                sendCommand(steps);
            }
        }

        requestAnimationFrame(trackLoop);
    }

    function sendCommand(steps) {
        const now = Date.now();
        // Limit to 10 commands per second (100ms delay)
        // This prevents choking the WiFi connection
        if (now - lastRequestTime > 100) {
            const ip = document.getElementById('ip').value;
            fetch(`http://${ip}/move?steps=${steps}`, { mode: 'no-cors' }).catch(e => {});
            lastRequestTime = now;
        }
    }
</script>
</body>
</html>
